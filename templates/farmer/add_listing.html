{% extends "base.html" %}

{% block title %}Add New Product Listing{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
             <h1 class="mb-0 h4"><i class="fas fa-plus-circle me-2"></i>Add New Product Listing</h1>
        </div>
        <div class="card-body">
            <p class="card-text text-muted mb-4">Fill out the details below to list your product for sale.</p>

            {# Display flash messages inside card body #}
            {% include '_flash_messages.html' %}

            {# Added enctype for file uploads #}
            <form method="POST" action="{{ url_for('main.farmer_add_listing') }}" class="needs-validation" novalidate enctype="multipart/form-data">
                 {# Add CSRF token if using Flask-WTF #}
                 {# {{ form.csrf_token if form and form.csrf_token }} #}

                {# Basic Info Section #}
                <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-2">Basic Information</legend>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ form_data.get('name', '') }}" required autocomplete="off">
                            <div class="invalid-feedback">Product name is required.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" disabled {% if not form_data.get('category') %}selected{% endif %}>Select a category...</option>
                                <option value="Vegetable" {% if form_data.get('category') == 'Vegetable' %}selected{% endif %}>Vegetable</option>
                                <option value="Fruit" {% if form_data.get('category') == 'Fruit' %}selected{% endif %}>Fruit</option>
                                <option value="Meat" {% if form_data.get('category') == 'Meat' %}selected{% endif %}>Meat</option>
                                <option value="Poultry" {% if form_data.get('category') == 'Poultry' %}selected{% endif %}>Poultry</option>
                                <option value="Dairy" {% if form_data.get('category') == 'Dairy' %}selected{% endif %}>Dairy</option>
                                <option value="Grain" {% if form_data.get('category') == 'Grain' %}selected{% endif %}>Grain</option>
                                <option value="Other" {% if form_data.get('category') == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                            <div class="invalid-feedback">Please select a category.</div>
                        </div>

                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Provide some details about your product...">{{ form_data.get('description', '') }}</textarea>
                        </div>
                    </div>
                </fieldset>

                {# Pricing & Quantity Section #}
                 <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-2">Pricing & Quantity</legend>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="price" class="form-label">Price (PHP) <span class="text-danger">*</span></label>
                             <div class="input-group">
                                <span class="input-group-text">â‚±</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="price" name="price" value="{{ form_data.get('price', '') }}" required autocomplete="off" placeholder="e.g., 50.00">
                                <div class="invalid-feedback">Please enter a valid price.</div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="unit" class="form-label">Unit <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="unit" name="unit" placeholder="e.g., kg, piece, bundle" value="{{ form_data.get('unit', '') }}" required autocomplete="off">
                            <div class="invalid-feedback">Please specify the unit.</div>
                        </div>

                         <div class="col-md-4">
                            <label for="quantity_available" class="form-label">Quantity Available <span class="text-danger">*</span></label>
                            <input type="number" step="0.1" min="0" class="form-control" id="quantity_available" name="quantity_available" value="{{ form_data.get('quantity_available', '') }}" required autocomplete="off" placeholder="e.g., 10.5">
                             <div class="invalid-feedback">Please enter the available quantity.</div>
                        </div>
                    </div>
                </fieldset>

                {# Image Upload Section #}
                <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-2">Product Image</legend>
                     <div class="col-12">
                        <label for="image_file" class="form-label">Upload Image (Optional)</label>
                        <input class="form-control" type="file" id="image_file" name="image_file" accept=".png, .jpg, .jpeg, .gif" onchange="previewImage(event)">
                         <div class="form-text">Allowed: png, jpg, jpeg, gif. Max size recommended: 2MB.</div>
                         {# Image Preview Area #}
                         <img id="image_preview" src="#" alt="Image Preview" style="max-height: 150px; max-width: 200px; margin-top: 10px; display: none; border-radius: 4px; border: 1px solid #ddd;"/>
                    </div>
                </fieldset>

                <hr class="my-4">

                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('main.farmer_manage_listings') }}" class="btn btn-secondary">Cancel</a>
                    <button class="btn btn-primary" type="submit"><i class="fas fa-check me-1"></i> Add Listing</button>
                </div>
            </form>
        </div> {# End card-body #}
    </div> {# End card #}
</div>

{% endblock %}

{% block body_end_extra %}
{# Bootstrap validation script #}
<script>
(function () {
  'use strict'
  var forms = document.querySelectorAll('.needs-validation')
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
})();

// Image Preview Script
function previewImage(event) {
    var reader = new FileReader();
    var imageField = document.getElementById("image_preview");
    reader.onload = function(){
        if(reader.readyState == 2){
            imageField.style.display = 'block';
            imageField.src = reader.result;
        }
    }
    if (event.target.files[0]) {
        reader.readAsDataURL(event.target.files[0]);
    } else {
        imageField.style.display = 'none';
        imageField.src = '#';
    }
}
</script>
{% endblock %}
