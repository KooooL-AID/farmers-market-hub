{% extends "base.html" %}

{% block title %}Edit Product Listing{% endblock %}

{% block content %}
<div class="container mt-4">
     <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
             <h1 class="mb-0 h4"><i class="fas fa-pencil-alt me-2"></i>Edit Product Listing</h1>
        </div>
        <div class="card-body">
             <p class="card-text text-muted mb-4">Update the details for your product: <strong>{{ listing.name }}</strong></p>

             {# Display flash messages inside card body #}
             {% include '_flash_messages.html' %}

            {# Added enctype for file uploads #}
            <form method="POST" action="{{ url_for('main.farmer_edit_listing', listing_id=listing.id) }}" class="needs-validation" novalidate enctype="multipart/form-data">
                 {# Add CSRF token if using Flask-WTF #}
                 {# {{ form.csrf_token if form and form.csrf_token }} #}

                 {# Basic Info Section #}
                <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-2">Basic Information</legend>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ form_data.get('name', listing.name) }}" required autocomplete="off">
                            <div class="invalid-feedback">Product name is required.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" disabled>Select a category...</option>
                                {% set current_category = form_data.get('category', listing.category) %}
                                <option value="Vegetable" {% if current_category == 'Vegetable' %}selected{% endif %}>Vegetable</option>
                                <option value="Fruit" {% if current_category == 'Fruit' %}selected{% endif %}>Fruit</option>
                                <option value="Meat" {% if current_category == 'Meat' %}selected{% endif %}>Meat</option>
                                <option value="Poultry" {% if current_category == 'Poultry' %}selected{% endif %}>Poultry</option>
                                <option value="Dairy" {% if current_category == 'Dairy' %}selected{% endif %}>Dairy</option>
                                <option value="Grain" {% if current_category == 'Grain' %}selected{% endif %}>Grain</option>
                                <option value="Other" {% if current_category == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                            <div class="invalid-feedback">Please select a category.</div>
                        </div>

                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ form_data.get('description', listing.description) }}</textarea>
                        </div>
                    </div>
                </fieldset>

                 {# Pricing & Quantity Section #}
                 <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-2">Pricing & Quantity</legend>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="price" class="form-label">Price (PHP) <span class="text-danger">*</span></label>
                             <div class="input-group">
                                <span class="input-group-text">â‚±</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="price" name="price" value="{{ form_data.get('price', listing.price) }}" required autocomplete="off">
                                <div class="invalid-feedback">Please enter a valid price.</div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="unit" class="form-label">Unit <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="unit" name="unit" placeholder="e.g., kg, piece" value="{{ form_data.get('unit', listing.unit) }}" required autocomplete="off">
                            <div class="invalid-feedback">Please specify the unit.</div>
                        </div>

                         <div class="col-md-4">
                            <label for="quantity_available" class="form-label">Quantity Available <span class="text-danger">*</span></label>
                            <input type="number" step="0.1" min="0" class="form-control" id="quantity_available" name="quantity_available" value="{{ form_data.get('quantity_available', listing.quantity_available) }}" required autocomplete="off">
                             <div class="invalid-feedback">Please enter the available quantity.</div>
                        </div>
                    </div>
                </fieldset>

                {# Image Upload Section #}
                <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-2">Product Image</legend>
                    <div class="row">
                        <div class="col-md-8">
                             <label for="image_file" class="form-label">Upload New Image (Optional)</label>
                             <input class="form-control" type="file" id="image_file" name="image_file" accept=".png, .jpg, .jpeg, .gif" onchange="previewEditImage(event)">
                             <div class="form-text">Leave empty to keep the current image. Upload a new file to replace it.</div>
                             {% if listing.image_filename %}
                             <div class="form-check mt-2">
                               <input class="form-check-input" type="checkbox" value="1" id="remove_image" name="remove_image">
                               <label class="form-check-label" for="remove_image">
                                 Remove current image
                               </label>
                             </div>
                             {% endif %}
                        </div>
                         {# Image Preview Area #}
                        <div class="col-md-4 text-center text-md-end">
                             <label class="form-label d-block mb-1">Current / Preview:</label>
                             <img id="image_preview_edit"
                                  src="{{ url_for('main.uploaded_file', filename=listing.image_filename) if listing.image_filename else 'https://placehold.co/200x150/EFEFEF/AAAAAA?text=No+Image' }}"
                                  alt="Image Preview"
                                  style="max-height: 120px; max-width: 100%; border-radius: 4px; border: 1px solid #ddd; object-fit: cover; aspect-ratio: 4/3;"
                                  onerror="this.onerror=null;this.src='https://placehold.co/200x150/CCCCCC/FFFFFF?text=Error';">
                        </div>
                    </div>
                </fieldset>

                 {# Status Section #}
                 <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-2">Listing Status</legend>
                    <div class="row">
                         <div class="col-md-6">
                             {% if listing.status in ['active', 'inactive', 'sold_out'] %}
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    {% set current_status = form_data.get('status', listing.status) %}
                                    <option value="active" {% if current_status == 'active' %}selected{% endif %}>Active (Visible to buyers)</option>
                                    <option value="inactive" {% if current_status == 'inactive' %}selected{% endif %}>Inactive (Hidden from buyers)</option>
                                    <option value="sold_out" {% if current_status == 'sold_out' %}selected{% endif %}>Sold Out</option>
                                </select>
                                <div class="form-text">Change the visibility of your listing.</div>
                             {% else %}
                                 <label class="form-label">Current Status</label>
                                 <input type="text" class="form-control" value="{{ listing.status.replace('_', ' ') | title }}" readonly disabled>
                                 <div class="form-text">This status is managed by the site administrator.</div>
                             {% endif %}
                         </div>
                    </div>
                 </fieldset>

                <hr class="my-4">

                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('main.farmer_manage_listings') }}" class="btn btn-secondary">Cancel</a>
                    <button class="btn btn-primary" type="submit"><i class="fas fa-save me-1"></i> Save Changes</button>
                </div>
            </form>
        </div> {# End card-body #}
    </div> {# End card #}
</div>

{% endblock %}

{% block body_end_extra %}
{# Bootstrap validation script #}
<script>
(function () {
  'use strict'
  var forms = document.querySelectorAll('.needs-validation')
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
})();

// Image Preview Script for Edit Page
function previewEditImage(event) {
    var reader = new FileReader();
    var imageField = document.getElementById("image_preview_edit");
    var removeCheckbox = document.getElementById("remove_image");

    reader.onload = function(){
        if(reader.readyState == 2){
            imageField.src = reader.result;
            // Uncheck "remove image" if a new image is selected
            if (removeCheckbox) {
                removeCheckbox.checked = false;
            }
        }
    }
    if (event.target.files[0]) {
        reader.readAsDataURL(event.target.files[0]);
    }
    // Optional: Revert to original if file selection is cancelled?
    // else { imageField.src = "{{ url_for('main.uploaded_file', filename=listing.image_filename) if listing.image_filename else 'https://placehold.co/200x150/EFEFEF/AAAAAA?text=No+Image' }}"; }
}
</script>
{% endblock %}
