{% extends "base.html" %} {% block title %} Conversation with {{
other_user.username if other_user else 'User' }} {% if
conversation.product_listing %} - {{ conversation.product_listing.name }} {%
endif %} {% endblock %} {% block head_extra %}
<style>
  .chat-container {
    max-width: 800px;
    margin: auto;
  }
  .message-bubble {
    padding: 10px 15px;
    border-radius: 20px;
    margin-bottom: 10px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .message-sent {
    background-color: #0d6efd; /* Bootstrap primary */
    color: white;
    margin-left: auto; /* Align to right */
    border-bottom-right-radius: 5px;
  }
  .message-received {
    background-color: #e9ecef; /* Bootstrap light grey */
    color: #212529;
    margin-right: auto; /* Align to left */
    border-bottom-left-radius: 5px;
  }
  .message-meta {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 2px;
  }
  .message-sent .message-meta {
    text-align: right;
  }
  .message-received .message-meta {
    text-align: left;
  }
  .chat-box {
    height: 400px; /* Adjust as needed */
    overflow-y: auto;
    border: 1px solid #ced4da;
    padding: 15px;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
    background-color: #fff;
  }
  .chat-input-form {
    display: flex;
  }
  .chat-input-form textarea {
    flex-grow: 1;
    margin-right: 10px;
    resize: none; /* Prevent manual resize */
    min-height: 40px; /* Start with a smaller height */
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4 mb-5 chat-container">
  <div class="card shadow-sm">
    <div
      class="card-header bg-light d-flex justify-content-between align-items-center"
    >
      <h4 class="mb-0 h5">
        <i class="fas fa-comments me-2"></i>
        Chat with {{ other_user.username if other_user else 'User' }} {% if
        conversation.product_listing %}
        <small class="text-muted d-block fs-6"
          >Regarding: {# Assuming you have a route to view a specific product #}
          {# Adjust the route if necessary, or link to browse_products #}
          <a
            href="{{ url_for('main.browse_products') }}#product-{{ conversation.product_listing.id }}"
            class="text-decoration-none"
          >
            {{ conversation.product_listing.name }}
          </a>
        </small>
        {% endif %}
      </h4>
      <a
        href="{{ url_for('main.list_conversations') }}"
        class="btn btn-sm btn-outline-secondary"
      >
        <i class="fas fa-arrow-left me-1"></i> Back to Inbox
      </a>
    </div>

    <div class="card-body">
      {# Display flash messages #} {% include '_flash_messages.html' %}

      <div class="chat-box" id="chatBox">
        {% if messages %} {% for message in messages %}
        <div
          class="message-bubble {% if message.sender_id == current_user.id %}message-sent{% else %}message-received{% endif %}"
        >
          {# *** CORRECTED THIS LINE *** #}
          <p class="mb-0">
            {{ message.content | replace('\n', '<br />') | safe }}
          </p>
          <div class="message-meta">
            {{ message.timestamp.strftime('%Y-%m-%d %H:%M') }} {% if
            message.sender_id == current_user.id and message.is_read %}
            <i class="fas fa-check-double text-info ms-1" title="Read"></i>
            {% elif message.sender_id == current_user.id %} {#
            <i class="fas fa-check text-muted ms-1" title="Sent"></i> #} {%
            endif %}
          </div>
        </div>
        {% endfor %} {% else %}
        <p class="text-center text-muted">
          No messages in this conversation yet. Start by sending a message
          below.
        </p>
        {% endif %}
      </div>

      <form
        method="POST"
        action="{{ url_for('main.view_conversation', conversation_id=conversation.id) }}"
        class="chat-input-form"
      >
        {# Add CSRF token if using Flask-WTF #} {#
        <input
          type="hidden"
          name="csrf_token"
          value="{{ csrf_token() if csrf_token else '' }}"
        />
        #}
        <textarea
          name="content"
          class="form-control"
          rows="2"
          placeholder="Type your message..."
          required
          aria-label="Message content"
        ></textarea>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane me-1"></i> Send
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block body_end_extra %}
<script>
  // Scroll chat box to the bottom
  var chatBox = document.getElementById("chatBox");
  if (chatBox) {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Auto-resize textarea (optional)
  const textarea = document.querySelector(".chat-input-form textarea");
  if (textarea) {
    textarea.addEventListener("input", autoResize, false);
    function autoResize() {
      this.style.height = "auto"; // Reset height
      this.style.height = this.scrollHeight + "px"; // Set to scroll height
    }
    // Optional: Initial resize if content already exists (e.g. on page load with draft)
    // autoResize.call(textarea);
  }
</script>
{% endblock %}
