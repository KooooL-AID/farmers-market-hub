{% extends "base.html" %}

{% block content %}
<section class="container mt-5">
    <h1 class="text-primary mb-4">Browse Fresh Produce</h1>

    {# Search and Filter Form - Improved layout and responsiveness #}
    <form method="GET" action="{{ url_for('main.browse_products') }}" class="mb-4 p-3 bg-light rounded shadow-sm filter-form">
        <div class="row g-2 g-md-3 align-items-center justify-content-start">
            {# Search Input #}
            <div class="col-12 col-sm-6 col-md-4 col-lg-4">
                <label for="search" class="visually-hidden">Search Products</label>
                <div class="input-group input-group-sm">
                     <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" name="search" id="search" class="form-control" placeholder="Search products..." value="{{ search or '' }}">
                </div>
            </div>
             {# Category Select #}
            <div class="col-12 col-sm-6 col-md-3 col-lg-3">
                 <label for="category" class="visually-hidden">Category</label>
                <select name="category" id="category" class="form-select form-select-sm">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
             {# Search Button #}
            <div class="col-12 col-sm-auto"> {# Auto width on larger screens #}
                <button type="submit" class="btn btn-primary btn-sm w-100 w-sm-auto"> {# Full width on smallest screens #}
                    Filter / Search
                </button>
            </div>
            {# Cart Link - Aligned to the right on medium+ screens #}
            <div class="col-12 col-md-auto ms-md-auto mt-2 mt-md-0 text-start text-md-end">
                 <a href="{{ url_for('main.view_cart') }}" class="btn btn-outline-success btn-sm position-relative">
                     <i class="fas fa-shopping-cart me-1"></i> Cart
                     {% if cart_item_count > 0 %}
                         <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                             {{ cart_item_count }}
                             <span class="visually-hidden">items in cart</span>
                         </span>
                     {% endif %}
                 </a>
            </div>
        </div>
    </form>

    {# Product Grid #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 product-grid">
        {# Loop through products #}
        {% for product in products %}
        <div class="col">
            {# Added product-card class for styling #}
            <div class="card h-100 shadow-sm product-card">
                {# Product Image #}
                <div class="product-card-img-container"> {# Container for potential badges/overlay #}
                    {% if product.image_filename %}
                    <img src="{{ url_for('main.uploaded_file', filename=product.image_filename) }}" class="card-img-top product-card-img" alt="{{ product.name }}">
                    {% else %}
                    {# Placeholder image using placehold.co #}
                    <img src="https://placehold.co/600x400/EBF3E8/777?text={{ product.name|replace(' ', '+') }}" class="card-img-top product-card-img" alt="Placeholder image for {{ product.name }}">
                    {% endif %}
                     {# Optional: Add badges here (e.g., "New", "Sale") #}
                     {# <span class="badge bg-danger position-absolute top-0 end-0 m-2">Sale</span> #}
                </div>

                {# Card Body #}
                <div class="card-body d-flex flex-column product-card-body">
                    {# Product Name #}
                    <h5 class="card-title product-card-title mb-1" title="{{ product.name }}">{{ product.name }}</h5>
                     {# Farmer Info - subtle #}
                     <p class="card-text product-card-farmer mb-2">
                        <small class="text-muted">
                            <i class="fas fa-store-alt me-1"></i>{{ product.farmer.username }}
                        </small>
                    </p>
                     {# Category - subtle #}
                    {# <p class="card-text product-card-category mb-2"><small class="text-muted">{{ product.category }}</small></p> #}
                    {# Price - more prominent #}
                    <p class="card-text product-card-price mb-2">
                        <strong>â‚±{{ "%.2f"|format(product.price) }}</strong> / {{ product.unit }}
                    </p>
                    {# Available Quantity - subtle, changes color if low #}
                    <p class="card-text product-card-stock mb-auto"> {# mb-auto pushes form to bottom #}
                        <small {% if product.quantity_available < 5 %}class="text-danger fw-bold"{% else %}class="text-muted"{% endif %}>
                            {% if product.quantity_available > 0 %}
                                {{ product.quantity_available }} {{ product.unit }} left
                            {% else %}
                                Out of stock
                            {% endif %}
                        </small>
                    </p>

                    {# Add to Cart Form - aligned to bottom #}
                    <form action="{{ url_for('main.add_to_cart', listing_id=product.id) }}" method="POST" class="mt-3 product-card-form" {% if product.quantity_available <= 0 %}style="display: none;"{% endif %}> {# Hide form if out of stock #}
                        <div class="input-group input-group-sm">
                             {# Quantity Input #}
                             <input type="number" name="quantity" class="form-control quantity-input" value="1" min="0.1" step="0.1" aria-label="Quantity" title="Quantity" {% if product.quantity_available <= 0 %}disabled{% endif %}>
                             {# Add to Cart Button #}
                             <button type="submit" class="btn btn-success add-to-cart-btn" title="Add to Cart" {% if product.quantity_available <= 0 %}disabled{% endif %}>
                                <i class="fas fa-cart-plus"></i>
                                <span class="d-none d-md-inline ms-1">Add</span> {# Hide text on smaller screens #}
                            </button>
                        </div>
                    </form>
                     {# Show message if out of stock #}
                     {% if product.quantity_available <= 0 %}
                        <div class="mt-3 text-center">
                            <span class="badge bg-secondary">Out of Stock</span>
                        </div>
                     {% endif %}

                    {# *** MOVED "MESSAGE FARMER" BUTTON HERE (INSIDE THE LOOP AND CARD BODY) *** #}
                    {% if current_user.is_authenticated and current_user.is_buyer and product.farmer and product.farmer.id != current_user.id %}
                        <form action="{{ url_for('main.start_conversation', listing_id=product.id) }}" method="POST" class="mt-2">
                            {# Add CSRF token if using Flask-WTF #}
                            {# <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}"> #}
                            <button type="submit" class="btn btn-outline-secondary btn-sm w-100">
                                <i class="fas fa-comments me-1"></i> Message Farmer
                            </button>
                        </form>
                    {% elif not current_user.is_authenticated and product.farmer %}
                        <a href="{{ url_for('main.login', next=url_for('main.browse_products')) }}" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                            <i class="fas fa-comments me-1"></i> Login to Message Farmer
                        </a>
                    {% endif %}
                    {# *** END OF MOVED SECTION *** #}

                </div> {# End card-body #}
            </div> {# End card #}
        </div> {# End col #}
        {% else %}
        {# Message if no products found - This part is OUTSIDE the loop #}
        <div class="col-12">
            <div class="alert alert-info text-center" role="alert">
                No products found matching your criteria. Try adjusting your search or filters.
            </div>
        </div>
        {% endfor %} {# End of the main product loop #}
    </div> {# End row/product-grid #}

    {# The "Message Farmer" button snippet should NOT be here if it was mistakenly placed outside the loop #}
    {# It needs to be INSIDE the "for product in products" loop, within each product's card #}

</section>
{% endblock %}
